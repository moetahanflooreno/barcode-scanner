<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flooreno Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    touch-action: manipulation;
}

h2 {
    text-align: center;
    font-size: 28px;
    font-weight: bold;
    background: linear-gradient(90deg, #007BFF 50%, #FF3B3B 50%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 10px;
}

.container {
    padding: 12px;
    background: #fff;
    min-height: 100vh;
}

button {
    border: none;
    border-radius: 6px;
    font-size: 16px;
    touch-action: manipulation;
}

.camera-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

.start-btn { flex: 3; background: #1e1efd; color: #fff; padding: 14px; }
.stop-btn { flex: 1; background: #e74c3c; color: #fff; padding: 14px; }

.export-btn, .clear-btn {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    color: #fff;
}

.export-btn { background: #1e1efd; }
.clear-btn { background: #e74c3c; }

#video {
    width: 100%;
    height: 200px;
    display: none;
    margin-bottom: 10px;
    border-radius: 6px;
    object-fit: cover;
}

.inputs {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 12px;
}

input {
    padding: 14px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ccc;
    touch-action: manipulation;
}

/* Table */
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    table-layout: fixed;
}

th, td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: center;
}

th.col-num, td.col-num { width: 36px; }
th.col-del, td.col-del { width: 40px; }
th.col-qty, td.col-qty { width: auto; }

/* Qty layout */
.qty-box {
    display: flex;
    width: 100%;
    align-items: stretch;
    gap: 4px;
}

.qty-btn {
    width: 34px;
    font-size: 20px;
    font-weight: bold;
    background: #eee;
    border-radius: 4px;
    touch-action: manipulation;
}

.qty-input {
    flex: 1;
    width: 100%;
    font-size: 16px;
    text-align: center;
    border-radius: 4px;
    border: 1px solid #ccc;
    inputmode: numeric;
    pattern: "[0-9]*";
}

.delete-btn {
    background: #e74c3c;
    color: #fff;
    width: 34px;
    height: 34px;
    border-radius: 4px;
    touch-action: manipulation;
}

/* Highlight colors for duplicates */
.dup-color-1 { background: #fff3cd; }
.dup-color-2 { background: #d4edda; }
.dup-color-3 { background: #d1ecf1; }
.dup-color-4 { background: #f8d7da; }
</style>
</head>

<body>
<div class="container">
    <h2>Flooreno Scanner</h2>

    <div class="camera-controls">
        <button class="start-btn" onclick="startCamera()">Start Camera</button>
        <button class="stop-btn" onclick="stopCamera(true)">Stop</button>
    </div>

    <video id="video" playsinline></video>

    <div class="inputs">
        <input id="scanInput" type="text" placeholder="Scan or enter barcode">
        <input id="qtyInput" type="number" placeholder="Qty (manual entry)" min="1" inputmode="numeric">
    </div>

    <div id="uniqueCount" style="margin-bottom:10px; font-weight:bold;">Unique SKUs: 0</div>

    <table>
        <thead>
            <tr>
                <th class="col-num">#</th>
                <th>SKU</th>
                <th class="col-qty">Qty</th>
                <th class="col-del">X</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <button class="export-btn" onclick="exportCSV()">Export CSV</button>
    <button class="clear-btn" onclick="clearAll()">Clear All</button>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const video = document.getElementById("video");
const scanInput = document.getElementById("scanInput");
const qtyInput = document.getElementById("qtyInput");
const tableBody = document.getElementById("tableBody");
const uniqueCountDiv = document.getElementById("uniqueCount");

let codeReader;
let cameraRunning = false;
let lastScanTime = 0;
const scanDelay = 600; // 0.6 sec between scans

const highlightColors = ["dup-color-1","dup-color-2","dup-color-3","dup-color-4"];

/* üîä Beep */
function playBeep() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.frequency.value = 1000;
    g.gain.value = 0.2;
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + 0.1);
}

/* üì∑ Camera scan */
function startCamera() {
    if (cameraRunning) return;
    cameraRunning = true;
    video.style.display = "block";

    codeReader = new ZXing.BrowserMultiFormatReader();
    codeReader.decodeFromVideoDevice(null, video, result => {
        const now = Date.now();
        if(result && now - lastScanTime > scanDelay) {
            lastScanTime = now;
            playBeep();
            addRowFast(result.text,1);
            setTimeout(startCamera, 120);
        }
    });
}

function stopCamera() {
    if (codeReader) codeReader.reset();
    cameraRunning = false;
    video.style.display = "none";
}

/* ‚ûï Add row */
function addRowFast(barcode, qty) {
    if(barcode.startsWith("210") && barcode.length===13) barcode=barcode.slice(0,-1);

    const tr=document.createElement("tr");
    tr.innerHTML=`
        <td class="col-num row-num"></td>
        <td>${barcode}</td>
        <td class="col-qty">
            <div class="qty-box">
                <button class="qty-btn">‚àí</button>
                <input class="qty-input" type="number" min="1" value="${qty}" inputmode="numeric" pattern="[0-9]*">
                <button class="qty-btn">+</button>
            </div>
        </td>
        <td class="col-del"><button class="delete-btn">X</button></td>
    `;

    const minus = tr.querySelectorAll(".qty-btn")[0];
    const plus = tr.querySelectorAll(".qty-btn")[1];
    const input = tr.querySelector(".qty-input");

    minus.onclick=()=>{ input.value=Math.max(1,parseInt(input.value)-1); save(); highlightDuplicates(); updateUniqueCount(); };
    plus.onclick=()=>{ input.value=parseInt(input.value)+1; save(); highlightDuplicates(); updateUniqueCount(); };
    input.onchange=()=>{ save(); highlightDuplicates(); updateUniqueCount(); };

    tr.querySelector(".delete-btn").onclick=()=>{ tr.remove(); renumber(); save(); highlightDuplicates(); updateUniqueCount(); };

    tableBody.prepend(tr);
    renumber(); save(); highlightDuplicates(); updateUniqueCount();

    scanInput.value=""; qtyInput.value="";
}

/* ‚å®Ô∏è Manual add with ENTER/tick */
function tryManualAdd(){
    const code=scanInput.value.trim();
    const qty=parseInt(qtyInput.value);
    if(!code) return;
    if(!qty || qty<1){ qtyInput.focus(); return; }
    addRowFast(code,qty);
    scanInput.focus();
}

/* ENTER handlers for scan & qty */
scanInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); tryManualAdd(); } });
qtyInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); tryManualAdd(); } });

/* üî¢ Reverse numbering */
function renumber(){
    const rows=[...tableBody.children]; const total=rows.length;
    rows.forEach((r,i)=> r.querySelector(".row-num").innerText=total-i);
}

/* üíæ Storage */
function save(){
    const data=[];
    tableBody.querySelectorAll("tr").forEach(r=>{
        data.push({ id:r.children[1].innerText, qty:r.querySelector(".qty-input").value });
    });
    localStorage.setItem("scannedItems",JSON.stringify(data));
}

/* Highlight duplicates */
function highlightDuplicates(){
    const skuMap={};
    [...tableBody.children].forEach(row=>{
        const sku=row.children[1].innerText;
        if(!skuMap[sku]) skuMap[sku]=[];
        skuMap[sku].push(row);
    });

    let colorIndex=0;
    Object.values(skuMap).forEach(rows=>{
        const color = rows.length>1?highlightColors[colorIndex%highlightColors.length]:"";
        rows.forEach(r=>{
            highlightColors.forEach(c=>r.classList.remove(c));
            if(color) r.classList.add(color);
        });
        if(rows.length>1) colorIndex++;
    });
}

/* Unique SKU count */
function updateUniqueCount(){
    const skus=new Set([...tableBody.children].map(r=>r.children[1].innerText));
    uniqueCountDiv.innerText=`Unique SKUs: ${skus.size}`;
}

function load(){
    const data=JSON.parse(localStorage.getItem("scannedItems")||"[]");
    data.reverse().forEach(d=>addRowFast(d.id,d.qty));
}

/* üßπ Clear */
function clearAll(){
    if(!confirm("Clear all scanned items?")) return;
    tableBody.innerHTML=""; localStorage.removeItem("scannedItems");
    highlightDuplicates(); updateUniqueCount();
}

/* üìÅ Export CSV (combine duplicates) */
function exportCSV(){
    let name=prompt("Enter file name:","scanned_items");
    if(!name) return;
    if(!name.endsWith(".csv")) name+=".csv";

    const combined={};
    tableBody.querySelectorAll("tr").forEach(r=>{
        let id=r.children[1].innerText;
        let qty=parseInt(r.querySelector(".qty-input").value);
        if(id.startsWith("210") && id.length===13) id=id.slice(0,-1);
        if(combined[id]) combined[id]+=qty; else combined[id]=qty;
    });

    let csv="System Id,Order Qty\n";
    Object.entries(combined).forEach(([id,qty])=>{ csv+=`${id},${qty}\n`; });

    const blob=new Blob([csv],{type:"text/csv"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=name;
    a.click();
}

/* üö´ iOS double-tap zoom prevention */
let lastTouch=0;
document.addEventListener('touchend',function(e){
    const now=(new Date()).getTime();
    if(now-lastTouch<=300) e.preventDefault();
    lastTouch=now;
},false);

load(); highlightDuplicates(); updateUniqueCount();
</script>
</body>
</html>
